## TCP/IP协议  
互联网协议（Internet Protocol Suite）是一个网络通信模型，以及一整个网络传输协议家族，为互联网的基础通信架构。它常被通称为TCP/IP协议族（TCP/IP Protocol Suite，或TCP/IP Protocols），简称TCP/IP。因为该协议家族的两个核心协议：TCP（传输控制协议）和IP（网际协议），为该家族中最早通过的标准。由于在网络通讯协议普遍采用分层的结构，当多个层次的协议共同工作时，类似计算机科学中的堆栈，因此又被称为TCP/IP协议栈（TCP/IP Protocol Stack）。    

TCP/IP协议包括TCP、IP、UDP、ICMP、RIP、TELNET、FTP、SMTP、ARP等许多协议。这些协议最早发源于美国国防部（缩写为DoD）的ARPA网项目，因此也被称作DoD模型（DoD Model）。这个协议族由互联网工程任务组负责维护。      

TCP/IP提供点对点的链接机制，将数据应该如何封装、定址、传输、路由以及在目的地如何接收，都加以标准化。它将软件通信过程抽象化为四个抽象层，采取协议堆栈的方式，分别实现出不同通信协议。协议族下的各种协议，依其功能不同，被分别归属到这四个层次结构之中，常被视为是简化的七层OSI模型。  

TCP/IP模型和OSI模型  
![](https://raw.githubusercontent.com/heshan0302/Returning-late/master/picture/TCPIP%E6%A8%A1%E5%9E%8B%E5%92%8COSI%E6%A8%A1%E5%9E%8B.png)   

![](https://raw.githubusercontent.com/heshan0302/Returning-late/master/picture/%E4%B8%A4%E7%A7%8D%E6%A8%A1%E5%9E%8B%E5%AF%B9%E5%BA%94%E5%85%B3%E7%B3%BB.png)


## TCP/IP协议层次   

### 网络接口层（网络访问层）     
+ 物理层是定义物理介质的各种特性：  
1、机械特性；  
2、电子特性；  
3、功能特性；  
4、规程特性。  
+ 数据链路层是负责接收IP数据包并通过网络发送，或者从网络上接收物理帧，抽出IP数据包，交给IP层。  
+ 常见的接口层协议有：Ethernet Ⅱ    
+ Ethernet Ⅱ 结构  
![](https://images2017.cnblogs.com/blog/1232796/201710/1232796-20171017084041287-1347335048.png)  
前导信息：由前导码（7byte）和帧起始（1byte）组成。  
目的物理地址：6byte，48位，表示帧准备发往目的地的MAC地址。  
源物理地址：6byte，48位，发送端的网卡MAC地址。  
类型：2byte，字段标识，表示上层协议。  
数据：需要交给上层的数据，以太网帧数据长度规定最小为46byte，最大为1500byte，如果有不到46字节时，会用填充字节填充到最小长度。最大值也叫最大传输单元（MTU）。  
帧序列检测：FCS，校验位。检查该帧是否出错。  

### 网络层    
+ 负责相邻计算机之间的通信。其功能包括三方面。  
1.处理来自传输层的分组发送请求，收到请求后，将分组装入IP数据报，填充报头，选择去往信宿机的路径，然后将数据报发往适当的网络接口。  
2.处理输入数据报：首先检查其合法性，然后进行寻径--假如该数据报已到达信宿机，则去掉报头，将剩下部分交给适当的传输协议；假如该数据报尚未到达信宿，则转发该数据报。  
3.处理路径、流控、拥塞等问题。  
+ 网络层包括：    
IP(Internet Protocol）协议：IP是网络层的核心，通过路由选择将下一条IP封装后交给接口层。IP数据报是无连接服务。      
ICMP(Internet Control Message Protocol)控制报文协议：ICMP是网络层的补充，可以回送报文。用来检测网络是否通畅。Ping命令就是发送ICMP的echo包，通过回送的echo relay进行网络测试。       
ARP(Address Resolution Protocol）正向地址转换协议：通过已知的IP，寻找对应主机的MAC地址。      
RARP(Reverse ARP)反向地址转换协议：通过MAC地址确定IP地址，比如无盘工作站应用。     

+ IP协议    
运行于 OSI 网络层  
面向无连接的协议  
独立处理数据包  
分层编址  
尽力而为传输  
无数据恢复功能    

+ IP报文头部    
![](https://raw.githubusercontent.com/heshan0302/Returning-late/master/IP%E6%8A%A5%E6%96%87%E5%A4%B4%E9%83%A8.png)    
版本:占4位,指IP协议的版本目前的IP协议版本号为4。     
首部长度:占4位,可表示的最大数值是15个单位，一个单位为4字节，因此IP的首部长度的最大值是60字节。    
区分服务:占8位,用来获得更好的服务,在旧标准中叫做服务类型,但实际上一直未被使用过.后改名为区分服务.只有在使用区分服务(DiffServ)时,这个字段才起作用.一般的情况下不使用。    
总长度:占16位,指首部和数据之和的长度,单位为字节,因此数据报的最大长度为65535字节。          
标识:占16位,它是一个计数器。通常，每发送一个报文，该值会加1，也用于数据包分片，在同一个包的若干分片中，该值是相同的。    
标志(flag):占3位,目前只有后两位有意义。      
&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;DF：（Don’t Fragment）中间的一位，只有当DF=0时才允许分片，DF=1，说明没有分片。      
&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;MF：（More Fragment）最后一位，MF=1表示后面还有分片；MF=0：表示最后一个分片。        
片偏移:占12位,指较长的分组在分片后，该分片在原分组中的相对位置。片偏移以8个字节为偏移单位。    
生存时间:占8位,记为TTL(Time To Live)。指数据报在网络中可通过的路由器数的最大值,TTL字段是由发送端初始设置一个8bit字段。推荐的初始值由分配数字RFC指定,当前值为64.发送ICMP回显应答时经常把TTL设为最大值255。TTL的值存放在配置文件   /proc/sys/net/ipv4/ip_default_ttl中。       
协议:占8位,指出此数据报携带的数据使用何种协议以便目的主机的IP层将数据部分上交给哪个处理过程。1表示为ICMP协议，2表示为IGMP协议，6表示为TCP协议，17表示为UDP协议。      
首部检验和:占16位,只检验数据报的首部不检验数据部分。    
源地址和目的地址:都各占4字节,分别记录源地址和目的地址。   
 

### 传输层      
&ensp;&ensp;&ensp;&ensp;提供应用程序间的通信。其功能包括：一、格式化信息流；二、提供可靠传输。为实现后者，传输层协议规定接收端必须发回确认，并且假如分组丢失，必须重新发送，即耳熟能详的“三次握手”过程，从而提供可靠的数据传输。  
&ensp;&ensp;&ensp;&ensp;传输层协议主要是：传输控制协议TCP(Transmission Control Protocol）和用户数据报协议UDP(User Datagram protocol）。  

#### TCP协议   

+ TCP特性    
工作在传输层  
面向连接协议  
全双工协议  
半关闭  
错误检查  
将数据打包成段，排序  
确认机制  
数据恢复，重传  
流量控制，滑动窗口  
拥塞控制，慢启动和拥塞避免算法     

+ TCP的报文头部    
![](https://raw.githubusercontent.com/heshan0302/Returning-late/master/TCP%E6%8A%A5%E6%96%87%E5%A4%B4%E9%83%A8.png)      
源端口、目标端口：     
计算机上的进程要和其他进程通信是要通过计算机端口的，而一个计算机端口某个时刻只能被一个进程占用，所以通过指定源端口和目标端口，就可以知道是哪两个进程需要通信。源端口、目标端口是用16位表示的，可推算计算机的端口个数为2^16个，端口范围为0~65535。    
序列号：    
表示本报文段所发送数据的第一个字节的编号。在TCP连接中所传送的字节流的每一个字节都会按顺序编号。由于序列号由32位表示，所以每2^32个字节，就会出现序列号回绕，再次从0开始。    
确认号：    
表示接收方期望收到发送方下一个报文段的第一个字节数据的编号。也就是告诉发送方：我希望你（指发送方）下次发送的数据的第一个字节数据的编号为此确认号。    
数据偏移：  
表示TCP报文段的首部长度，共4位，由于TCP首部包含一个长度可变的选项部分，需要指定这个TCP报文段到底有多长。它指出TCP报文段的数据起始处距离TCP报文段的起始处有多远。该字段的单位是32位(即4个字节为计算单位），4位二进制最大表示15，所以数据偏移也就是TCP首部最大60字节。  
URG：  
表示本报文段中发送的数据是否包含紧急数据。后面的紧急指针字段（urgent pointer）只有当URG=1时才有效。  
ACK：  
确认位。表示是否前面确认号字段是否有效。只有当ACK=1时，前面的确认号字段才有效。TCP规定，连接建立后，ACK必须为1,带ACK标志的TCP报文段称为确认报文段。  
PSH：  
提示接收端应用程序应该立即从TCP接收缓冲区中读走数据，为接收后续数据腾出空间。如果为1，则表示对方应当立即把数据提交给上层应用，而不是缓存起来，如果应用程序不将接收到的数据读走，就会一直停留在TCP接收缓冲区中。   
RST：  
如果收到一个RST=1的报文，说明与主机的连接出现了严重错误（如主机崩溃），必须释放连接，然后再重新建立连接。或者说明上次发送给主机的数据有问题，主机拒绝响应，带RST标志的TCP报文段称为复位报文段。  
SYN：  
同步位。在建立连接时使用，用来同步序号。当SYN=1，ACK=0时，表示这是一个请求建立连接的报文段；当SYN=1，ACK=1时，表示对方同意建立连接。SYN=1，说明这是一个请求建立连接或同意建立连接的报文。只有在前两次握手中SYN才置为1，带SYN标志的TCP报文段称为同步报文段。  
FIN：    
分手位。表示通知对方本端要关闭连接了，标记数据是否发送完毕。如果FIN=1，即告诉对方：“我的数据已经发送完毕，你可以释放连接了”，带FIN标志的TCP报文段称为结束报文段。      
窗口大小：    
表示现在允许对方发送的数据量，也就是告诉对方，从本报文段的确认号开始允许对方发送的数据量，达到此值，需要ACK确认后才能再继续传送后面数据，由Window size value * Window size scaling factor（此值在三次握手阶段TCP选项Window scale协商得到）得出此值，此值是随时变化的。   
校验和：    
提供额外的可靠性   
紧急指针：    
标记紧急数据在数据字段中的位置   
选项部分：    
其最大长度可根据TCP首部长度进行推算。TCP首部长度用4位表示，选项部分最长为：(2^4-1)*4-20=40字节    
常见选项：    
最大报文段长度：Maxium Segment Size，MSS，通常1460字节  
窗口扩大：Window Scale  
时间戳： Timestamps ，区分相同序列号的不同报文。     


+ TCP三次握手    
![](https://images2015.cnblogs.com/blog/824490/201512/824490-20151209134608480-1590076700.jpg)   


+ sync半连接和accept全连接队列    
![](https://raw.githubusercontent.com/heshan0302/Returning-late/master/sync%E5%8D%8A%E8%BF%9E%E6%8E%A5%E5%92%8Caccept%E5%85%A8%E8%BF%9E%E6%8E%A5%E9%98%9F%E5%88%97.png)    
存放半连接队列大小的配置文件：    
/proc/sys/net/ipv4/tcp_max_syn_backlog    
存放全连接队列大小的配置文件：    
/proc/sys/net/core/somaxconn     

+ TCP四次挥手  
![](https://raw.githubusercontent.com/heshan0302/Returning-late/master/TCP%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B.png)    

+ 有限状态机FSM:Finite State Machine  
CLOSED 没有任何连接状态   
LISTEN 侦听状态，等待来自远方TCP端口的连接请求  
SYN-SENT 在发送连接请求后，等待对方确认  
SYN-RECEIVED 在收到和发送一个连接请求后，等待对方确认  
ESTABLISHED 代表传输连接建立，双方进入数据传送状态  
FIN-WAIT-1 主动关闭,主机已发送关闭连接请求，等待对方确认  
FIN-WAIT-2 主动关闭,主机已收到对方关闭传输连接确认，等待对方发送关闭传输连接请求  
TIME-WAIT 完成双向传输连接关闭，等待所有分组消失  
CLOSE-WAIT 被动关闭,收到对方发来的关闭连接请求，并已确认  
LAST-ACK 被动关闭,等待最后一个关闭传输连接确认，并等待所有分组消失  
CLOSING 双方同时尝试关闭传输连接，等待对方确认    

+ 四次挥手的三种情况    
客户端先发送一个FIN给服务端，自己进入了FIN_WAIT_1状态，这时等待接收服务端的报文，该报文会有三种可能：  
&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;只有服务端的ACK  
&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;只有服务端的FIN  
&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;基于服务端的ACK，又有FIN  
1、只收到服务器的ACK，客户端会进入FIN_WAIT_2状态，后续当收到服务端的FIN时，回应发送一个ACK，会进入到TIME_WAIT状态，这个状态会持续2MSL(TCP报文段在网络中的最大生存时间, RFC 1122标准的建议值是2min).客户端等待2MSL，是为了当最后一个ACK丢失时，可以再发送一次。因为服务端在等待超时后会再发送一个FIN给客户端，进而客户端知道ACK已丢失。  
2、只有服务端的FIN时，回应一个ACK给服务端，进入CLOSING状态，然后接收到服务端的ACK时，进入TIME_WAIT状态。  
3、同时收到服务端的ACK和FIN，直接进入TIME_WAIT状态。    

+ 客户端的典型状态转移  
客户端通过connect系统调用主动与服务器建立连接connect系统调用首先给服务器发送一个同步报文段，使连接转移到SYN_SENT状态。此后connect系统调用可能因为如下两个原因失败返回：  
1、如果connect连接的目标端口不存在（未被任何进程监听），或者该端口仍被处于TIME_WAIT状态的连接所占用，则服务器将给客户端发送一个复位报文段，connect调用失败。  
2、如果目标端口存在，但connect在超时时间内未收到服务器的确认报文段，则connect调用失败。  
connect调用失败将使连接立即返回到初始的CLOSED状态。如果客户端成功收到服务器的同步报文段和确认，则connect调用成功返回，连接转移至ESTABLISHED状态。     

+ 客户端的典型状态转移  
当客户端执行主动关闭时，它将向服务器发送一个结束报文段，同时连接进入FIN_WAIT_1状态。若此时客户端收到服务器专门用于确认目的的确认报文段，则连接转移至FIN_WAIT_2状态。当客户端处于FIN_WAIT_2状态时，服务器处于CLOSE_WAIT状态，这一对状态是可能发生半关闭的状态。此时如果服务器也关闭连接（发送结束报文段），则客户端将给予确认并进入TIME_WAIT状态。
客户端从FIN_WAIT_1状态可能直接进入TIME_WAIT状态（不经过FIN_WAIT_2状态），前提是处于FIN_WAIT_1状态的服务器直接收到带确认信息的结束报文段（而不是先收到确认报文段，再收到结束报文段）。    

+ 客户端的典型状态转移  
处于FIN_WAIT_2状态的客户端需要等待服务器发送结束报文段，才能转移至TIME_WAIT状态，否则它将一直停留在这个状态。如果不是为了在半关闭状态下继续接收数据，连接长时间地停留在FIN_WAIT_2状态并无益处。连接停留在FIN_WAIT_2状态的情况可能发生在：客户端执行半关闭后，未等服务器关闭连接就强行退出了。此时客户端连接由内核来接管，可称之为孤儿连接（和孤儿进程类似）。  
Linux为了防止孤儿连接长时间存留在内核中，定义了两个内核参数：  
/proc/sys/net/ipv4/tcp_max_orphans 指定内核能接管的孤儿连接数目  
/proc/sys/net/ipv4/tcp_fin_timeout 指定孤儿连接在内核中生存的时间    




#### UDP协议    

+ UDP特性    
工作在传输层  
提供不可靠的网络访问  
非面向连接协议  
有限的错误检查  
传输性能高  
无数据恢复特性  

+ UDP报文头部    
![](https://raw.githubusercontent.com/heshan0302/Returning-late/master/UDP%E6%8A%A5%E6%96%87%E5%A4%B4%E9%83%A8.png)    
源端口、目标端口：各16位；  
UDP长度，UDP校验位：各16位。  

    

### 应用层  
+ 向用户提供一组常用的应用程序，比如电子邮件、文件传输访问、远程登录等。远程登录TELNET使用TELNET协议提供在网络其它主机上注册的接口。TELNET会话提供了基于字符的虚拟终端。文件传输访问FTP使用FTP协议来提供网络内机器间的文件拷贝功能。  
+ 应用层协议主要包括如下几个：FTP、TELNET、DNS、SMTP、NFS、HTTP。  
FTP(File Transfer Protocol）是文件传输协议，一般上传下载用FTP服务，数据端口是20H，控制端口是21H。  
Telnet服务是用户远程登录服务，使用23H端口，使用明码传送，保密性差、简单方便。  
DNS(Domain Name Service）是域名解析服务，提供域名到IP地址之间的转换，使用端口53。  
SMTP(Simple Mail Transfer Protocol）是简单邮件传输协议，用来控制信件的发送、中转，使用端口25。   
NFS（Network File System）是网络文件系统，用于网络中不同主机间的文件共享。  
HTTP(Hypertext Transfer Protocol）是超文本传输协议，用于实现互联网中的WWW服务，使用端口80。    



## port    
传输层通过port号，确定应用层协议。由互联网数字分配机构（IANA）分配。  
Port number:    
0-1023：  
系统端口或特权端口(仅管理员可用)。众所周知，永久的分配给固定的系统应用使用，22/tcp(ssh), 80/tcp(http), 443/tcp(https)；  
1024-49151：  
用户端口或注册端口，但要求并不严格，分配给程序注册为某应用使用，如1433/tcp(SqlServer), 1521/tcp(oracle),3306/tcp(mysql),11211/tcp/udp(memcached)；
49152-65535：  
动态端口或私有端口，客户端程序随机使用的端口；  
其范围的定义：/proc/sys/net/ipv4/ip_local_port_range  
















